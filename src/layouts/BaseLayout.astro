---
import { fetchSiteInfo, fetchSettings } from '../lib/wp';

const { title = 'Sunny Astro', description = 'Astro + WordPress' } = Astro.props;
const siteInfo = await fetchSiteInfo();
const siteName = siteInfo.name || 'Sunny';
const settings = await fetchSettings();

// 如果传入的 title 就是网站名称（首页），只显示网站名称
// 否则显示 "页面标题 - 网站标题" 格式
const pageTitle = title === siteName ? siteName : `${title} - ${siteName}`;

// CSS 列表（按顺序引入）
const cssList = [
  '/style/fancybox.css',
  '/style/main.css',
  '/style/pagination.css',
  '/style/article.css',
  '/style/code-macos.css',
];

// JS 列表（按顺序引入，jquery 需在最前）
const jsList = [
  '/style/jquery.min.js',
  '/style/fancybox.umd.js',
  '/style/jquery.md5.min.js',
  '/style/lazysizes.min.js',
  '/style/main.js',
  '/style/code-copy.js',
  '/style/comments.js',
  '/style/instantpage.js',
];

// instantpage.js 需要放在 head 中使用 type="module"
const headJs = jsList.filter((src) => /instantpage\.js$/i.test(src));
const bodyJs = jsList.filter((src) => !/instantpage\.js$/i.test(src));
---
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="color-scheme" content="light dark" />

    <!-- 关键：在任何 CSS 之前立即执行，防止闪烁 -->
    <script>
      !function(){
        // 检测黑夜模式 cookie
        var isDark = /(?:^|;\s*)night\s*=\s*1/.test(document.cookie);
        // 调试输出（可选，测试后可删除）
        console.log('[Theme] Cookie:', document.cookie);
        console.log('[Theme] Is dark mode:', isDark);
        // 立即应用 darkmode 类
        if(isDark) {
          document.documentElement.classList.add("darkmode");
          console.log('[Theme] Applied darkmode class');
        }
      }();
    </script>

    <style>
      /* 关键：立即应用背景色，使用直接值而非变量，防止被覆盖 */
      html{
        background:#fff !important;
        color:#4a4a4a;
      }
      html.darkmode{
        background:#1a1a1a !important;
        color:#e0e0e0;
      }
      body{
        margin:0;
        background:inherit;
        color:inherit;
      }
      /* 预设 CSS 变量，会被后续样式覆盖为用户自定义值 */
      :root{
        --background:#fff;
        --background-1:#fff;
        --background-2:#fff;
        --background-3:#fff;
        --color:#4a4a4a;
      }
      :root.darkmode{
        --background:#1a1a1a;
        --background-1:#1e1e1e;
        --background-2:#222;
        --background-3:#252525;
        --color:#e0e0e0;
      }
    </style>

    <title>{pageTitle}</title>
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="sitemap" type="application/xml" title="Sitemap" href="/sitemap.xml" />

    {cssList.map((href) => (
      <link rel="stylesheet" href={href} />
    ))}

    {headJs.map((src) => (
      <script type="module" src={src}></script>
    ))}

    <style define:vars={{ settings }} set:text={`
      :root {
        --theme: ${settings.theme_color || '#49b1f5'};
        --theme-60: ${settings.theme_color || '#49b1f5'}99;
        --theme-30: ${settings.theme_color || '#49b1f5'}4D;
        --background: ${settings.background_color || '#ffffff'};
        --background-1: ${settings.background_color || '#ffffff'};
        --background-2: ${settings.background_color || '#ffffff'};
        --background-3: ${settings.background_color || '#ffffff'};
        --color: ${settings.text_color || '#4a4a4a'};
        --colorC: ${settings.text_color || '#4a4a4a'}99;
        --colorB: ${settings.text_color || '#4a4a4a'}4D;
        --colorA: ${settings.text_color || '#4a4a4a'}1A;
        --box-shadow: ${settings.box_shadow || '0 1px 3px rgba(0,0,0,0.08)'};
        --code-bg: ${settings.code_bg || '#f8f8f8'};
        --code-color: ${settings.code_color || '#525252'};
        --margin: ${settings.margin || '1rem'};
      }
      html.darkmode {
        --background: ${settings.dark_background || '#1a1a1a'};
        --background-1: ${settings.dark_background_1 || '#1e1e1e'};
        --background-2: ${settings.dark_background_2 || '#222222'};
        --background-3: ${settings.dark_background_3 || '#252525'};
        --color: ${settings.dark_text_color || '#e0e0e0'};
        --colorC: ${settings.dark_text_color || '#e0e0e0'}99;
        --colorB: ${settings.dark_text_color || '#e0e0e0'}4D;
        --colorA: ${settings.dark_text_color || '#e0e0e0'}1A;
        --box-shadow: ${settings.dark_box_shadow || '0 1px 3px rgba(0,0,0,0.3)'};
        --code-bg: ${settings.dark_code_bg || '#2d2d2d'};
        --code-color: ${settings.dark_code_color || '#f8f8f2'};
      }
    `}></style>

    <!-- PJAX 配置：阻止分页链接使用 PJAX -->
    <script define:vars={{ settings }} set:text={`
      window.PJAX_CONFIG = {
        timeout: 10000,
        cacheBust: false,
        selectors: ['title', '.main'],
        switches: { '.main': 'append' },
        analytics: true,
        scrollRestoration: true,
        requestOptions: {
          headers: {
            'X-PJAX': 'true',
            'X-Requested-With': 'XMLHttpRequest'
          }
        }
      };
      // 阻止分页链接使用 PJAX（保留普通页面跳转）
      window.PJAX_CONFIG.selectors.push('.cat_pagination a');
    `}></script>

    <!-- 自定义头部代码 -->
    <Fragment set:html={settings.head_code || ''} />

    <!-- PJAX 支持 -->
    <script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script>

  </head>
  <body>
    <!-- 自定义顶部代码 -->
    <Fragment set:html={settings.body_top_code || ''} />

    <slot />

    <!-- 自定义底部代码 -->
    <Fragment set:html={settings.body_bottom_code || ''} />

    {bodyJs.map((src) => (
      <script is:inline src={src}></script>
    ))}

    <!-- PJAX 初始化：阻止分页链接使用 PJAX -->
    <script is:inline set:text={`
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof Pjax !== 'undefined') {
          var pjax = new Pjax(window.PJAX_CONFIG);

          // 阻止分页链接使用 PJAX
          document.addEventListener('pjax:send', function(e) {
            var trigger = e.trigger;
            if (trigger && (
              trigger.hasAttribute('data-no-pjax') ||
              (trigger.classList && (
                trigger.classList.contains('page-number') ||
                trigger.classList.contains('page-nav')
              ))
            )) {
              e.preventDefault();
              return false;
            }
          });

          // PJAX 完成后立即恢复黑夜模式状态
          document.addEventListener('pjax:success', function() {
            var isDark = /(?:^|;\\s*)night\\s*=\\s*1/.test(document.cookie);
            var de = document.documentElement;
            if (isDark) {
              de.classList.add('darkmode');
            } else {
              de.classList.remove('darkmode');
            }
          });
        }
      });
    `}></script>

  </body>
</html>
<style>
/* 初始化样式 */
.main_screen {
  opacity: 0;
  transition: opacity 0.4s ease;
}
.main_screen.loaded {
  opacity: 1;
}
.loading_circle {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 2.5rem;
  height: 2.5rem;
  z-index: 9999;
}
.loading_circle svg {
  width: 100%;
  height: 100%;
  color: var(--theme);
  animation: spin 1s linear infinite;
}
@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
.percentage {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  background: var(--theme);
  color: #fff;
  border-radius: 50%;
  width: 2.2rem;
    height: 2.2rem;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0.8;
    font-size: 0.75rem;
    transition: opacity 0.2s;
    z-index: 999;
}
.percentage:hover {
    opacity: 1;
}
.darkmode .percentage {
    background: var(--theme-60);
}

/* PJAX 加载动画 */
.pjax-loading {
  pointer-events: none;
  opacity: 0.8;
}

/* 分页样式增强 */
.cat_pagination {
    margin: 2rem 0;
}

/* 隐藏原有的无限滚动提示 */
.cat_archive_next .next {
    display: none;
}

/* 显示页码分页 */
.cat_archive_next:has(.cat_pagination) {
    margin: 2rem 0;
}

@media (max-width: 768px) {
    .percentage {
        bottom: 4rem;
        right: 0.5rem;
    }
}
</style>