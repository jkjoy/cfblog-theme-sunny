---
import type { WPComment } from '../lib/wp';

interface Props {
  postId: number;
  comments: WPComment[];
  authorId?: number;
  enableDynamicLoading?: boolean; // 是否启用动态加载
}

const { postId, comments, authorId, enableDynamicLoading = true } = Astro.props;
const buildTime = Date.now(); // 记录构建时间

function withAvatarMirror(url: string | undefined): string {
  const mirror = import.meta.env.PUBLIC_AVATAR_MIRROR || '';
  if (!url) return 'https://cn.cravatar.com/avatar/';
  if (!mirror) return url;
  try {
    const u = new URL(url);
    u.hostname = mirror.replace(/^https?:\/\//, '').replace(/\/$/, '');
    return u.toString();
  } catch {
    return url || 'https://cn.cravatar.com/avatar/';
  }
}

type CommentWithChildren = WPComment & { children: WPComment[] };

function buildCommentTree(flatComments: WPComment[]): CommentWithChildren[] {
  const map = new Map<number, CommentWithChildren>();
  const roots: CommentWithChildren[] = [];

  flatComments.forEach(comment => {
    map.set(comment.id, { ...comment, children: [] });
  });

  flatComments.forEach(comment => {
    const node = map.get(comment.id)!;
    if (comment.parent === 0) {
      roots.push(node);
    } else {
      const parent = map.get(comment.parent);
      if (parent) {
        parent.children.push(node);
      } else {
        roots.push(node);
      }
    }
  });

  return roots;
}

const commentTree = buildCommentTree(comments);

// 创建评论 ID 到评论的映射，用于获取父评论信息
const commentMap = new Map<number, WPComment>();
comments.forEach(c => commentMap.set(c.id, c));

function relativeTime(dateStr: string): string {
  const d = new Date(dateStr);
  const now = new Date();
  const diff = Math.max(0, now.getTime() - d.getTime());
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}分钟前`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}小时前`;
  const days = Math.floor(hours / 24);
  if (days < 30) return `${days}天前`;
  const months = Math.floor(days / 30);
  if (months < 12) return `${months}个月前`;
  const years = Math.floor(months / 12);
  return `${years}年前`;
}
---

<div id="comments" class="comment_part" data-post-id={postId} data-build-time={buildTime} data-enable-dynamic={enableDynamicLoading}>
  <!-- 评论表单 -->
  <div id="respond" class="respond">
    <form method="post" class="cat_block cat_comment_respond_form" action="#" data-type="text" data-post-id={postId} data-wp-url={import.meta.env.PUBLIC_WP_URL?.replace(/\/$/, '')}>
      <input type="hidden" name="parent" value="0" />
      <div class="top">
        <div class="replyavatar">
          <img class="avatar api_avatar" src="https://cn.cravatar.com/avatar/" alt="" />
        </div>
        <div class="head">
          <div class="list">
            <input type="email" id="toavatar" autocomplete="off" name="mail" placeholder="邮箱" required />
          </div>
          <div class="list">
            <input type="text" autocomplete="off" name="author" maxlength="16" placeholder="昵称" required />
          </div>
          <div class="list">
            <input type="url" autocomplete="off" name="url" placeholder="站点" />
          </div>
        </div>
      </div>
      <div class="body">
        <textarea name="text" class="Comment_Textarea" placeholder="注意文明发言哦！" required></textarea>
      </div>
      <div class="foot">
        <div class="right">
          <div id="cancel-comment-reply-link" class="cat_cancel_comment_reply send_anniu_style" style="display:none;">取消</div>
          <button type="submit" class="send_anniu_style">发表</button>
        </div>
      </div>
    </form>
  </div>

  <!-- 评论列表 -->
  {commentTree.length > 0 ? (
    <ol class="comment-list">
      {commentTree.map(comment => {
        const renderComment = (cmt: CommentWithChildren, level: number): any => {
          const isAuthor = authorId && cmt.author === authorId;
          const avatar = withAvatarMirror(cmt.author_avatar_urls?.['48'] || cmt.author_avatar_urls?.['96']);
          const isPending = cmt.status === 'hold' || cmt.status === 'waiting';
          const isReply = level > 0 || isAuthor;

          // 获取父评论信息
          const parentComment = cmt.parent ? commentMap.get(cmt.parent) : null;

          return (
            <li class={`${level > 0 ? 'cat_comment_child' : 'cat_comment_parent'} ${isReply ? 'huomiaoreply' : ''}`}>
              <div class="cat_comment_replyout" data-replyout-id={cmt.id}>
                <div class="cat_comment_body" id={`comment-${cmt.id}`} data-coid={cmt.id}>
                  <div class="cat_comment_reply" data-reply-id={cmt.id}>
                    <img class="avatar lazyload" src="/style/lazy.png" data-src={avatar} alt={cmt.author_name} />
                    <div class="replymengban">@</div>
                  </div>

                  <div class="content">
                    <div class="user" align={isReply ? 'right' : undefined}>
                      <span class="comment_user_name">
                        {cmt.author_url ? (
                          <a href={cmt.author_url} target="_blank" rel="external nofollow">{cmt.author_name}</a>
                        ) : (
                          cmt.author_name
                        )}
                      </span>
                      {parentComment && (
                        <a style="font-size: 0.75rem;display: inline; color: var(--colorC);" href={`#comment-${cmt.parent}`}>@{parentComment.author_name}</a>
                      )}
                      {isPending && <p class="waiting" style="color:var(--theme-60);">（评论审核中...）</p>}
                    </div>

                    <div class={`substance ${isAuthor ? 'iscat' : 'isfriend'}`} set:html={cmt.content.rendered}></div>

                    <div class="commentinfos" align={isReply ? 'right' : undefined}>
                      <time cat_title={new Date(cmt.date).toLocaleString('zh-CN')} class="date" datetime={cmt.date}>
                        {relativeTime(cmt.date)}
                      </time>
                    </div>
                  </div>
                </div>
              </div>

              {cmt.children.length > 0 && (
                <div class="comment-children">
                  <ol>
                    {cmt.children.map(child => renderComment(child, level + 1))}
                  </ol>
                </div>
              )}
            </li>
          );
        };

        return renderComment(comment, 0);
      })}
    </ol>
  ) : (
    <div class="cat_block" style="text-align: center; padding: 2rem;">
      暂无评论，快来抢沙发吧！
    </div>
  )}
</div>

<script>
  // 评论表单提交和回复功能
  document.addEventListener('DOMContentLoaded', function() {
    const commentForm = document.querySelector('.cat_comment_respond_form') as HTMLFormElement;
    if (!commentForm) return;

    const parentInput = commentForm.querySelector('[name="parent"]') as HTMLInputElement;
    const cancelBtn = document.querySelector('.cat_cancel_comment_reply') as HTMLElement;
    const emailInput = commentForm.querySelector('[name="mail"]') as HTMLInputElement;
    const authorInput = commentForm.querySelector('[name="author"]') as HTMLInputElement;
    const urlInput = commentForm.querySelector('[name="url"]') as HTMLInputElement;
    const textArea = commentForm.querySelector('[name="text"]') as HTMLTextAreaElement;

    // 从 localStorage 加载用户信息
    if (localStorage.getItem('comment_author_email')) {
      emailInput.value = localStorage.getItem('comment_author_email') || '';
    }
    if (localStorage.getItem('comment_author')) {
      authorInput.value = localStorage.getItem('comment_author') || '';
    }
    if (localStorage.getItem('comment_author_url')) {
      urlInput.value = localStorage.getItem('comment_author_url') || '';
    }

    // 回复按钮功能（点击@图标）
    document.querySelectorAll('.replymengban').forEach((replyBtn) => {
      replyBtn.addEventListener('click', function() {
        const commentBody = (this as HTMLElement).closest('.cat_comment_body');
        if (!commentBody) return;

        const commentId = commentBody.getAttribute('data-coid');
        const commentReplyout = commentBody.closest('.cat_comment_replyout');
        if (!commentId || !commentReplyout) return;

        // 设置父评论 ID
        parentInput.value = commentId;

        // 显示取消按钮
        if (cancelBtn) {
          cancelBtn.style.display = 'inline-block';
        }

        // 将表单移动到当前评论下方
        const respondDiv = document.getElementById('respond');
        if (respondDiv) {
          // 移动表单到评论后面
          commentReplyout.parentNode?.insertBefore(respondDiv, commentReplyout.nextSibling);
        }

        // 聚焦到文本框
        textArea.focus();
      });
    });

    // 取消回复
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        parentInput.value = '0';
        cancelBtn.style.display = 'none';

        // 将表单移回原位
        const respondDiv = document.getElementById('respond');
        const commentsDiv = document.getElementById('comments');
        if (respondDiv && commentsDiv) {
          commentsDiv.insertBefore(respondDiv, commentsDiv.firstChild);
        }
      });
    }

    // 评论表单提交
    commentForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(commentForm);
      const email = formData.get('mail') as string;
      const author = formData.get('author') as string;
      const url = formData.get('url') as string;
      const content = formData.get('text') as string;

      // 表单验证
      if (!email || !author || !content) {
        alert('请填写邮箱、昵称和评论内容！');
        return;
      }

      // 邮箱格式验证
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        alert('请输入有效的邮箱地址！');
        return;
      }

      // 保存用户信息到 localStorage
      localStorage.setItem('comment_author_email', email);
      localStorage.setItem('comment_author', author);
      localStorage.setItem('comment_author_url', url || '');

      // 获取文章ID和WordPress URL
      const postId = commentForm.getAttribute('data-post-id');
      const wpUrl = commentForm.getAttribute('data-wp-url');

      if (!postId || !wpUrl) {
        alert('无法获取文章ID或WordPress地址，请刷新页面重试！');
        return;
      }

      // 获取父评论ID（如果是回复）
      const parent = parentInput ? parseInt(parentInput.value) : 0;

      // 提交按钮
      const submitBtn = commentForm.querySelector('button[type="submit"]') as HTMLButtonElement;
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '提交中...';

      try {
        const response = await fetch(`${wpUrl}/wp-json/wp/v2/comments`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            post: parseInt(postId),
            author_name: author,
            author_email: email,
            author_url: url || undefined,
            content: content,
            parent: parent
          })
        });

        if (response.ok) {
          // 直接刷新页面并跳转到评论区
          window.location.href = window.location.pathname + window.location.search + '#comments';
        } else {
          const error = await response.json();
          console.error('评论提交失败:', error);
          alert(error.message || '评论提交失败，请稍后重试！');
        }
      } catch (error) {
        console.error('评论提交错误:', error);
        alert('评论提交失败，请检查网络连接！');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  });

  // 动态加载新评论
  async function loadDynamicComments() {
    const commentsDiv = document.getElementById('comments');
    if (!commentsDiv) return;

    const enableDynamic = commentsDiv.getAttribute('data-enable-dynamic') === 'true';
    if (!enableDynamic) return; // 如果未启用动态加载，直接返回

    const postId = commentsDiv.getAttribute('data-post-id');
    const buildTime = parseInt(commentsDiv.getAttribute('data-build-time') || '0');
    const wpUrl = commentForm?.getAttribute('data-wp-url');

    if (!postId || !wpUrl) return;

    try {
      // 从 WordPress API 获取最新评论
      const response = await fetch(`${wpUrl}/wp-json/wp/v2/comments?post=${postId}&per_page=100&orderby=date&order=asc`);
      if (!response.ok) return;

      const allComments = await response.json();

      // 筛选构建时间之后的新评论
      const newComments = allComments.filter((comment: any) => {
        const commentTime = new Date(comment.date).getTime();
        return commentTime > buildTime;
      });

      if (newComments.length > 0) {
        console.log(`发现 ${newComments.length} 条新评论，正在动态加载...`);
        // 刷新页面以显示新评论
        // 也可以选择动态插入 DOM，但刷新更简单
        window.location.reload();
      } else {
        console.log('没有新评论');
      }
    } catch (error) {
      console.error('动态加载评论失败:', error);
    }
  }

  // 页面加载后 2 秒检查新评论
  setTimeout(loadDynamicComments, 2000);

  // 每 30 秒检查一次新评论
  setInterval(loadDynamicComments, 30000);
</script>
