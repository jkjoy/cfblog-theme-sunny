---
import BaseLayout from "../layouts/BaseLayout.astro";
import Menu from "../components/Menu.astro";
import Sidebar from "../components/Sidebar.astro";
import { fetchPostsPage } from "../lib/wp";

const s = Astro.url.searchParams.get('s') || '';
const page = Number(Astro.url.searchParams.get('page') || '1');
const perPage = 10;
const { items: posts, totalPages } = await fetchPostsPage(page, perPage, s ? { search: s } : undefined);
---
<BaseLayout title={`ğŸ”${s || 'æœç´¢'}`}>
  <div class="main_screen">
    <Menu />
    <div class="main">
      <main class="main_body">
        <div class="title_block cat_block">
          <div class="title_block_title"><h1>ğŸ”{s || 'æœç´¢'}</h1></div>
        </div>
        <div class="postlist_out">
          {posts.length ? posts.map((p, idx) => {
            const tagsTerms = (p._embedded?.['wp:term'] || []).flat?.() || [];
            const tags = tagsTerms.filter((t: any) => t.taxonomy === 'post_tag');
            return (
              <div class="postlist cat_block" style={`animation-delay: ${200 * idx}ms;`}>
                <div class="top">
                  <div class="right">
                    <div class="postlist_title"><a href={`/${p.slug}/#read_article`} set:html={p.title.rendered}></a></div>
                    <div class="postlist_abstract" set:html={p.excerpt.rendered}></div>
                  </div>
                </div>
                <div class="postlist_info">
                  <div class="postlist_tags" itemprop="keywords">
                    <a href={`/${p.slug}/#comments`}>
                      <span class="pinglun">è¯„è®º</span>
                    </a>
                    {tags.map((t: any) => (
                      <a href={`/tag/${t.slug}/`}>{t.name}</a>
                    ))}
                  </div>
                </div>
              </div>
            );
          }) : (
            <div class="cat_block">æœªæ‰¾åˆ°åŒ¹é…çš„å†…å®¹</div>
          )}
        </div>
      </main>
      <aside class="main_sidebar">
        <Sidebar />
      </aside>
    </div>
  </div>
  {posts.length && (
    <div class="cat_archive_next">
      {page < totalPages && <a class="next" href={`/search?s=${encodeURIComponent(s)}&page=${page+1}`}>more</a>}
    </div>
  )}
</BaseLayout>
