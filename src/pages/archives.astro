---
import BaseLayout from "../layouts/BaseLayout.astro";
import Menu from "../components/Menu.astro";
import Sidebar from "../components/Sidebar.astro";
import { fetchAllPosts } from "../lib/wp";

const posts = await fetchAllPosts(50, 100);

// Group posts by year, then by month to avoid repeating the year header
type MonthGroups = Record<number, typeof posts>;
type YearGroup = { y: number; months: MonthGroups };
const yearGroups = posts.reduce((acc: Record<number, YearGroup>, p) => {
  const d = new Date(p.date);
  const y = d.getFullYear();
  const m = d.getMonth() + 1;
  acc[y] = acc[y] || { y, months: {} } as YearGroup;
  acc[y].months[m] = acc[y].months[m] || [];
  acc[y].months[m].push(p);
  return acc;
}, {} as Record<number, YearGroup>);
const sortedYears = Object.keys(yearGroups).map(Number).sort((a, b) => b - a);
---
<BaseLayout title="üìÅÁªüËÆ°ÂΩíÊ°£">
  <div class="main_screen">
    <Menu />
    <div class="main">
      <main class="main_body">
        <div class="cat_guidang">
          <div class="cat_block">
            {sortedYears.map((y) => {
              const months = yearGroups[y].months;
              const sortedMonths = Object.keys(months).map(Number).sort((a, b) => b - a);
              return (
                <>
                  <h3 style="text-align: center;padding: 2rem;">üìÅ {y} Âπ¥</h3>
                  <ul>
                    {sortedMonths.map((m) => (
                      <li>
                        <div style="padding-left: 4.2rem;">üìÖ {y} Âπ¥ {m} Êúà</div>
                        <ul class="cat_block">
                          {months[m]
                            .sort((a,b)=> new Date(a.date) > new Date(b.date) ? -1 : 1)
                            .map(p => (
                              <li class="item"><span>{new Date(p.date).getDate()}</span><a href={`/${p.slug}/` } set:html={p.title.rendered}></a></li>
                            ))}
                        </ul>
                      </li>
                    ))}
                  </ul>
                </>
              );
            })}
          </div>
        </div>
      </main>
      <aside class="main_sidebar">
        <Sidebar />
      </aside>
    </div>
  </div>
</BaseLayout>

