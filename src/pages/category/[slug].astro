---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Menu from "../../components/Menu.astro";
import Sidebar from "../../components/Sidebar.astro";
import { fetchCategories, fetchPostsByCategory, fetchUserById } from "../../lib/wp";

export async function getStaticPaths() {
  const cats = await fetchCategories();
  return cats.map(c => ({ params: { slug: c.slug } }));
}

const { slug } = Astro.params;
const cats = await fetchCategories();
const cat = cats.find(c => c.slug === slug);
if (!cat) throw new Error('Category not found');
const page = Number(Astro.url.searchParams.get('page') || '1');
const { items: posts, totalPages } = await fetchPostsByCategory(cat.id, page, 10);

const admin = await fetchUserById(1);
const adminName = admin.name;

function withAvatarMirror(url: string | undefined): string {
  const mirror = import.meta.env.PUBLIC_AVATAR_MIRROR || '';
  if (!url) return 'https://cn.cravatar.com/avatar/';
  if (!mirror) return url;
  try {
    const u = new URL(url);
    u.hostname = mirror.replace(/^https?:\/\//,'').replace(/\/$/,'');
    return u.toString();
  } catch { return url || 'https://cn.cravatar.com/avatar/'; }
}

const adminAvatar = withAvatarMirror(admin.avatar_urls?.['96'] || admin.avatar_urls?.['48'] || '');

function extractImages(html: string): string[] {
  const urls: string[] = [];
  if (!html) return urls;
  const seen = new Set<string>();
  const push = (u: string) => {
    if (u.startsWith('//')) u = 'https:' + u;
    if (!seen.has(u)) { seen.add(u); urls.push(u); }
  };
  const exts = '(?:png|jpe?g|gif|webp|svg|bmp|ico|avif|tiff?)';
  const reAbs = new RegExp(`https?:\\/\\/[^\s"'<>]+?\\.${exts}(?:\\?[^\s"'<>]*)?(?:#[^\s"'<>]*)?`, 'gi');
  const reProt = new RegExp(`(?:^|[^\\w])(\\/\\/[^\s"'<>]+?\\.${exts}(?:\\?[^\s"'<>]*)?(?:#[^\s"'<>]*)?)`, 'gi');
  const reRoot = new RegExp(`(?:^|[^\\w])(\\/[^"'<>\s]+?\\.${exts}(?:\\?[^\s"'<>]*)?(?:#[^\s"'<>]*)?)`, 'gi');
  let m: RegExpExecArray | null;
  while ((m = reAbs.exec(html)) && urls.length < 20) push(m[0]);
  while ((m = reProt.exec(html)) && urls.length < 20) push(m[1]);
  while ((m = reRoot.exec(html)) && urls.length < 20) push(m[1]);
  return urls;
}

function relativeTime(dateStr: string): string {
  const d = new Date(dateStr);
  const now = new Date();
  const diff = Math.max(0, now.getTime() - d.getTime());
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}åˆ†é’Ÿå‰`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}å°æ—¶å‰`;
  const days = Math.floor(hours / 24);
  if (days < 30) return `${days}å¤©å‰`;
  const months = Math.floor(days / 30);
  if (months < 12) return `${months}ä¸ªæœˆå‰`;
  const years = Math.floor(months / 12);
  return `${years}å¹´å‰`;
}

function isNew(dateStr: string): boolean {
  const created = new Date(dateStr).getTime();
  return (Date.now() - created) <= 3 * 24 * 60 * 60 * 1000;
}
---
<BaseLayout title={`ðŸ“‚${cat.name}`}>
  <div class="main_screen">
    <div class="loading_circle">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18.364 5.63604L16.9497 7.05025C15.683 5.7835 13.933 5 12 5C8.13401 5 5 8.13401 5 12C5 15.866 8.13401 19 12 19C15.866 19 19 15.866 19 12H21C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C14.4853 3 16.7353 4.00736 18.364 5.63604Z"></path></svg>
    </div>
    <Menu />
    <div class="main">
      <main class="main_body">
        <!-- æ ‡é¢˜å— -->
        <div class="title_block cat_block">
          <div class="title_block_title"><h1>ðŸ“‚{cat.name}</h1></div>
        </div>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div class="postlist_out">
          {posts.map((p, idx) => {
            const media = p._embedded?.['wp:featuredmedia']?.[0];
            const thumb = media?.source_url || '';
            const imgs = extractImages(p.content.rendered || '');
            const imageCount = imgs.length;
            const maxImages = Math.min(imageCount, 9);

            const tagsTerms = (p._embedded?.['wp:term'] || []).flat?.() || [];
            const tags = tagsTerms.filter((t: any) => t.taxonomy === 'post_tag');
            return (
              <div class="postlist cat_block" style={`animation-delay: ${200 * idx}ms;`} itemscope itemtype="http://schema.org/BlogPosting">
                <div class="top">
                  {thumb && (
                    <div class="left">
                      <span class="postlist_gallery" href={thumb} data-fancybox={`gallery ${p.id}`}>
                        <img class="lazyload postlist_img" src="/style/lazy.png" data-src={thumb} alt={p.title.rendered.replace(/<[^>]*>/g,'')} />
                      </span>
                    </div>
                  )}
                  <div class="right">
                    <div class="postlist_title">
                      <a href={`/${p.slug}/#read_article`} set:html={p.title.rendered}></a>
                    </div>
                    <div class="postlist_abstract" set:html={p.excerpt.rendered}></div>
                  </div>
                </div>
                <div class="postlist_head">
                  {adminAvatar && (
                    <a href={`/${p.slug}/`}>
                      <img class="avatar lazyload" src="/style/lazy.png" data-src={adminAvatar} alt={adminName} />
                    </a>
                  )}
                  <div class="middle">
                    <div class="top">{adminName}</div>
                    <div class="bottom">
                      <span cat_title={new Date(p.date).toLocaleDateString('zh-CN')}>{relativeTime(p.date)}</span>
                      {isNew(p.date) && <span style="color:#ff000099;"> Â· NEW!</span>}
                    </div>
                  </div>
                </div>
                <div class="postlist_info">
                  <div class="postlist_title">
                    <a href={`/${p.slug}/#read_article`} set:html={p.title.rendered}></a>
                  </div>
                  {imageCount === 0 && (
                    <div class="postlist_abstract" set:html={p.excerpt.rendered}></div>
                  )}
                  {imageCount > 0 && (
                    <div class="postlist_album" num={String(imageCount)}>
                      {Array.from({ length: maxImages }).map((_, i) => (
                        <span data-fancybox={`gallery${p.id}`} class="postlist_gallery" href={imgs[i]}>
                          <img class="lazyload postlist_img" src="/style/lazy.png" data-src={imgs[i]} alt={p.title.rendered.replace(/<[^>]*>/g,'')} />
                          {imageCount > 9 && i === 8 && (
                            <span class="mask"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path></svg>{imageCount - 9}</span>
                          )}
                        </span>
                      ))}
                    </div>
                  )}
                  <div class="postlist_tags" itemprop="keywords">
                    <a href={`/${p.slug}/#comments`}>
                      <span class="pinglun">è¯„è®º</span>
                    </a>
                    {tags.map((t: any) => (
                      <a href={`/tag/${t.slug}/`}>{t.name}</a>
                    ))}
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </main>
      <aside class="main_sidebar">
        <Sidebar />
      </aside>
    </div>
  </div>

  <div class="cat_archive_next">
    {page < totalPages && <a class="next" href={`/category/${slug}/?page=${page+1}`}>more</a>}
  </div>
</BaseLayout>
